# 基本設計書：Amazon販売KPI管理ツール

**バージョン**: 1.5  
**更新日**: 2025年8月6日  
**更新内容**: 物販KPIダッシュボード（MVP版）の追加・UI/UX全面刷新

## 1. システム概要

### 1.1 システム名称
Amazon販売KPI管理ツール（Googleスプレッドシート版）

### 1.2 システムの目的
- Amazonセラーセントラルとマカドのデータを統合し、月利80万円達成に向けたKPI管理を実現
- リアルタイムに近い形で販売状況を可視化し、データドリブンな意思決定を支援
- 在庫管理の最適化により、キャッシュフローの改善を図る
- 返品・キャンセルデータを含む包括的な売上分析
- **[新規] 1枚のダッシュボードで今月のKPI予実を即座に把握し、階層別分析を実現**
- **[新規] スライサー操作による直感的なデータフィルタリングとアラート管理**

### 1.3 システムの範囲
- Amazon SP-APIを通じた販売・在庫データの自動取得
- マカドCSVデータの取り込みと統合（Shift-JISエンコーディング対応）
- 返品・キャンセルデータの適切な処理
- KPI算出とダッシュボード表示（リアルタイム更新）
- アラート通知機能（目標未達、在庫異常検知）
- データエクスポート機能
- 重複データの自動検知・除外

### 1.4 利用者
- Amazon物販事業者（1名での運用を想定）
- 将来的には複数人での利用も考慮

## 2. システム構成

### 2.1 アーキテクチャ概要
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Amazon SP-API  │     │   マカド CSV    │     │   Keepa API     │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         └───────────────────────┴───────────────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │   Google Apps Script    │
                    │  (データ取得・処理)      │
                    └────────────┬────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │  Google Spreadsheet     │
                    │  (データ保存・表示)      │
                    └────────────┬────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │      ユーザー           │
                    └─────────────────────────┘
```

### 2.2 技術スタック
- **フロントエンド**: Google Spreadsheet
- **バックエンド**: Google Apps Script (GAS)
- **データソース**: 
  - Amazon SP-API (Reports, Orders, Inventory)
  - マカドCSV
  - Keepa API（オプション）
- **通知**: Gmail, Slack（オプション）

### 2.3 システム要件
- Google Workspace アカウント
- Amazon Seller Central アカウント（SP-API利用権限）
- マカドアカウント
- インターネット接続環境

## 3. 機能要件

### 3.1 データ取得機能
| 機能ID | 機能名 | 概要 | 優先度 |
|--------|--------|------|--------|
| F001 | Amazon注文データ取得 | SP-API経由で注文情報を定期取得 | 高 |
| F002 | Amazon在庫データ取得 | FBA在庫情報の日次取得 | 高 |
| F003 | マカドCSV取り込み | CSVファイルの自動/手動取り込み | 高 |
| F004 | Keepaデータ取得 | 商品の価格推移・売れ行き情報 | 中 |

### 3.2 データ処理機能
| 機能ID | 機能名 | 概要 | 優先度 |
|--------|--------|------|--------|
| F005 | データ統合処理 | 複数ソースのデータをSKU/ASINで統合 | 高 |
| F006 | KPI算出処理 | 各種KPIの自動計算・リアルタイム更新 | 高 |
| F007 | データクレンジング | 重複除去、異常値検出、返品データ処理 | 高 |
| F008 | 時系列集計 | 日次/週次/月次での集計処理 | 中 |
| F016 | エンコーディング変換 | Shift-JIS→UTF-8自動変換 | 高 |
| F017 | 返品・キャンセル処理 | 数量0データの適切な処理 | 高 |

### 3.3 表示機能
| 機能ID | 機能名 | 概要 | 優先度 |
|--------|--------|------|--------|
| F009 | KPIダッシュボード | 主要KPIの可視化 | 高 |
| F010 | 商品別分析画面 | SKU/ASIN別の詳細分析 | 中 |
| F011 | 在庫管理画面 | 在庫状況の一覧表示 | 高 |
| F012 | アラート表示 | 閾値超過時の警告表示 | 中 |
| F018 | 過去月実績表示 | 過去12ヶ月分のKPI推移表示 | 高 |
| F019 | 前月比較機能 | 前月・前年同月との比較分析 | 高 |
| F020 | 期間選択機能 | ドロップダウンによる過去12ヶ月分の期間選択 | 高 |
| F021 | 動的グラフ表示 | 売上・利益・ROI推移の動的グラフ表示 | 高 |
| F022 | 時系列分析表示 | 選択期間のKPIデータ表示・比較分析 | 高 |
| **F023** | **新ダッシュボード** | **8つのKPIカード・階層別予実テーブル・スライサー** | **高** |
| **F024** | **スパークライン** | **SKU別の7日間売上トレンド表示** | **高** |
| **F025** | **拡張アラート** | **在庫切れ・不良在庫・急激な変動・価格競争検知** | **高** |
| **F026** | **増分更新** | **15分/1時間/日次の段階的データ更新** | **高** |

### 3.4 通知機能
| 機能ID | 機能名 | 概要 | 優先度 |
|--------|--------|------|--------|
| F013 | エラー通知 | データ取得失敗時のメール通知 | 高 |
| F014 | KPIアラート | 目標値乖離時の通知 | 中 |
| F015 | 定期レポート | 日次/週次サマリーの自動送信 | 低 |

## 4. 非機能要件

### 4.1 パフォーマンス要件
- データ更新処理：10分以内で完了
- 画面表示：3秒以内でレスポンス
- 同時実行：1ユーザーでの利用を想定

### 4.2 セキュリティ要件
- API認証情報の暗号化保存
- アクセス権限の適切な設定
- 操作ログの記録

### 4.3 可用性要件
- Google Spreadsheetの可用性に準拠（99.9%）
- 日次バックアップの実施

### 4.4 保守性要件
- モジュール化された実装
- エラーログの詳細記録
- ドキュメントの整備

## 5. データ設計

### 5.1 スプレッドシート構成
| シート名 | 用途 | 更新頻度 | 読み書き |
|----------|------|----------|---------|
| KPI月次管理 | 月次KPIサマリー・時系列分析 | 日次 | 読み書き |
| KPI履歴 | 過去月のKPI実績データ | 月次 | 読み書き |
| 販売履歴 | 全注文明細 | リアルタイム | 読み取り専用 |
| 仕入履歴 | 仕入データ | 都度 | 読み取り専用 |
| 在庫一覧 | 現在庫状況 | 日次 | 読み取り専用 |
| ASIN/SKUマスタ | 商品マスタ情報 | 都度 | 読み取り専用 |
| データ連携ログ | 処理履歴 | 自動 | 書き込みのみ |
| **ダッシュボード** | **新KPIダッシュボード（MVP）** | **リアルタイム** | **読み書き** |
| **plan_monthly_input** | **月次目標入力** | **月次** | **書き込みのみ** |
| **ビュー_カテゴリ** | **カテゴリ別集計** | **リアルタイム** | **読み取り専用** |
| **ビュー_仕入先** | **仕入先別集計** | **リアルタイム** | **読み取り専用** |
| **ビュー_SKU** | **SKU別集計** | **リアルタイム** | **読み取り専用** |
| **設定** | **システム設定・しきい値** | **都度** | **読み書き** |

### 5.1.1 KPI月次管理シート詳細構成
| セル/エリア | 項目 | 概要 | 機能 |
|-------------|------|------|------|
| F2 | 期間選択ドロップダウン | 過去12ヶ月分の期間選択 | データ検証・選択リスト |
| A〜E列 | 基本KPI表示エリア | 売上・利益・ROI等の基本KPI | 既存機能 |
| F列 | 前年同月比エリア | 各KPIの前年同月比較 | VLOOKUP・条件付き書式 |
| G列以降 | グラフエリア | 動的グラフ表示 | 売上・利益・ROI推移グラフ |
| データ範囲 | 時系列データ | 選択期間のKPIデータ | 動的データ更新 |

### 5.1.2 新ダッシュボードシート構成
| エリア | 項目 | 概要 | 実装方法 |
|--------|------|------|----------|
| **上部コントロール** | スライサー | カテゴリ・仕入先フィルタ | Google標準スライサー |
| | 期間参照 | 設定!B2:C2を参照 | セル参照 |
| **KPIカード（8枚）** | 売上・粗利・粗利率・在庫回転 | 実績/目標/達成率/前月比 | SUMIFS・条件付き書式 |
| | DIO・返品率・CCC・新商品率 | 拡張KPI表示 | 計算式・視覚化 |
| **階層テーブル** | カテゴリ→仕入先→SKU | 3階層の予実表示 | QUERY・グループ化 |
| | スパークライン | 7日間売上トレンド | SPARKLINE関数 |
| **アラートエリア** | 在庫切れ・不良在庫 | リアルタイムアラート | FILTER関数 |
| | 急激な変動・価格競争 | 拡張アラート | 条件判定・表示 |

### 5.1.3 目標入力シート（plan_monthly_input）
| 列 | 項目 | 型 | 概要 |
|----|------|-----|------|
| A | 年月 | YYYY-MM | 対象年月 |
| B | 粒度 | business/category | 事業全体/カテゴリ別 |
| C | カテゴリコード | SHO_CATEGORY_CD | カテゴリ識別子 |
| D | 売上目標 | 数値 | 月次売上目標 |
| E | 粗利目標 | 数値 | 月次粗利目標 |
| F | 粗利率目標 | % | 目標粗利率 |
| G | 回転率目標 | 数値 | 目標在庫回転率 |
| H | CCC目標 | 日数 | 目標キャッシュサイクル |
| I | 新商品数目標 | 数値 | 新商品投入目標 |
| J | 備考 | テキスト | 任意メモ |

### 5.2 主要データ項目
#### 販売履歴
- 注文ID（プライマリキー）
- 注文日時
- ASIN
- SKU（統一SKU）
- 販売価格
- 仕入原価
- Amazon手数料
- 粗利益
- ステータス

#### 仕入履歴
- 統一SKU（プライマリキー）
- ASIN
- 仕入日
- 仕入先
- 仕入数量
- 仕入単価
- 仕入合計金額
- 送料
- 備考

#### 在庫一覧
- SKU（プライマリキー）
- ASIN
- 商品名
- 在庫数
- 在庫金額
- 回転日数
- 最終入荷日
- 最終販売日

## 6. インターフェース設計

### 6.1 外部インターフェース
- Amazon SP-API（REST API）
- マカドCSV（ファイル）
- Keepa API（REST API）

### 6.2 画面インターフェース
- Googleスプレッドシートのネイティブ機能を活用
- カスタムメニューによる操作
- 条件付き書式による視覚的フィードバック

## 7. 処理フロー

### 7.1 日次バッチ処理
```
1. Amazon SP-APIからデータ取得
2. マカドCSVの確認・取り込み
3. データクレンジング・統合
4. KPI算出
5. ダッシュボード更新
6. アラートチェック・通知
```

### 7.2 リアルタイム処理
- 手動実行によるデータ更新
- 個別商品の情報取得

### 7.3 時系列分析処理フロー
```
1. F2セル（期間選択）の変更検知
2. onEditトリガーによる処理開始
3. 選択された期間のKPIデータ取得
4. 前年同月データの検索・取得
5. 比較計算（前月比・前年同月比）
6. 表示データの動的更新
7. グラフデータ範囲の更新
8. 条件付き書式の再適用
```

### 7.4 グラフ更新処理フロー
```
1. KPI履歴シートから過去12ヶ月データ取得
2. 選択期間を基準とした時系列データ抽出
3. グラフデータ範囲の動的設定
4. 売上・利益・ROIグラフの個別更新
5. 軸設定・スケールの最適化
6. グラフタイトルの動的設定
```

### 7.5 新ダッシュボード更新フロー
```
1. 段階的データ更新
   - 15分毎：重要KPI（売上・在庫切れ）
   - 1時間毎：中間指標（粗利・回転率）
   - 日次：全データ再計算
2. 増分更新処理
   - 前回更新時刻からの差分データ取得
   - 影響範囲のKPIのみ再計算
3. スライサー連動更新
   - フィルタ条件変更の検知
   - 関連するビューシートの自動更新
4. エラーハンドリング
   - QUERY失敗時の代替表示
   - データ不整合の警告表示
```

### 7.6 アラート検知フロー
```
1. 基本アラート検知
   - 在庫切れ：在庫日数 <= 安全在庫日数
   - 不良在庫：DIO > 90日
   - 粗利未達：(目標-実績) TOP N
2. 拡張アラート検知
   - 急激な売上変動：前週比±30%以上
   - 価格競争：競合最安値との乖離15%以上
3. アラート表示
   - ダッシュボード内専用エリア
   - サイドバー表示（Apps Script）
```

## 8. エラー処理方針

### 8.1 エラー分類
- API接続エラー
- データ形式エラー
- 処理タイムアウト
- 権限エラー

### 8.2 エラー対応
- リトライ処理（3回まで）
- エラーログ記録
- 管理者への通知
- 部分的な処理継続

## 9. セキュリティ設計

### 9.1 認証・認可
- Google アカウントによる認証
- スプレッドシートの共有設定による権限管理

### 9.2 データ保護
- API認証情報のProperties Service保存
- 個人情報のマスキング
- 通信の暗号化（HTTPS）

## 10. 移行計画

### 10.1 段階的導入
1. Phase 1: 基本機能実装（2週間）
2. Phase 2: 自動化実装（1週間）
3. Phase 3: 高度な分析機能（2週間）
4. Phase 4: 運用最適化（継続的）

### 10.1.1 MVP版ダッシュボード実装計画（4日間）
| 日程 | タスク | 成果物 |
|------|--------|---------|
| Day 1 | 基本構造構築 | 設定/plan_monthly_input/ダッシュボード骨組み<br>スライサー設置<br>KPI 8枚（実績＆目標） |
| Day 2 | 階層ビュー実装 | カテゴリ/仕入先/SKUのQUERYビュー<br>スパークライン<br>条件付き書式 |
| Day 3 | アラート・自動化 | アラート抽出ロジック<br>Apps Script（メニュー/更新/CSV/サイドバー） |
| Day 4 | 最適化・仕上げ | 負荷最適化<br>権限・保護設定<br>UAT修正 → MVP完了 |

### 10.2 データ移行
- 既存データのインポート機能
- 過去データの一括取り込み

## 11. 運用・保守計画

### 11.1 定期メンテナンス
- 月次でのデータアーカイブ
- 四半期でのパフォーマンスチューニング

### 11.2 監視項目
- API利用状況
- エラー発生率
- 処理時間

## 12. KPI定義（詳細）

### 12.1 月次KPI（8指標体制）
| KPI名 | 計算式 | 目標値 | 説明 |
|-------|--------|--------|------|
| 売上高 | 販売価格 × 数量の合計 | 3,200,000円 | 月間総売上金額 |
| 粗利益 | 売上高 - 仕入原価 - 手数料 | 800,000円 | 月利目標額 |
| 利益率 | 粗利益 ÷ 売上高 × 100 | 25% | 収益性指標 |
| ROI | 粗利益 ÷ 仕入原価 × 100 | 30% | 投資効率指標 |
| 在庫回転率 | 売上原価 ÷ 平均在庫金額 | 1回/月 | 在庫効率指標 |
| **DIO** | **365 ÷ 在庫回転率** | **30日以下** | **在庫日数** |
| **返品率** | **返品数 ÷ 総販売数 × 100** | **3%以下** | **品質指標** |
| **CCC** | **在庫日数 + 売掛金日数 - 買掛金日数** | **0日以下** | **キャッシュサイクル** |
| **新商品投入率** | **新規投入SKU数 ÷ 総SKU数 × 100** | **10%以上** | **成長性指標** |

### 12.2 日次KPI
| KPI名 | 計算式 | 説明 |
|-------|--------|------|
| 本日売上 | 当日の販売金額合計 | 日次売上実績 |
| 本日利益 | 当日の粗利益合計 | 日次利益実績 |
| 成長率 | (本日実績 - 7日平均) ÷ 7日平均 × 100 | 前週比成長率 |

### 12.3 アラート閾値
#### 基本アラート
- 月利目標達成率 80%未満：高優先度アラート
- 在庫回転率 0.5未満：中優先度アラート
- 滞留在庫率 15%超過：中優先度アラート
- 在庫切れ：在庫日数 <= 安全在庫日数
- 不良在庫：DIO > 90日

#### 拡張アラート
- **急激な売上変動**：前週比±30%以上（売上1万円以上の商品対象）
- **価格競争検知**：競合最安値との乖離15%以上（出品者3社以上）
- **粗利未達寄与大**：(目標-実績)の降順TOP10
- **キャッシュ悪化**：CCC > 30日

### 12.4 過去月実績KPI
| 項目 | 内容 | 説明 |
|------|------|------|
| 表示期間 | 過去12ヶ月 | 当月を含む直近12ヶ月分 |
| 前月比 | 各KPIの前月比較 | 増減率を%で表示 |
| 前年同月比 | 前年同月との比較 | 年間成長率の把握 |
| トレンド | 移動平均線 | 3ヶ月移動平均で傾向把握 |

### 12.5 時系列分析機能KPI
| 項目 | 計算式 | 表示形式 | 説明 |
|------|--------|----------|------|
| 期間選択範囲 | F2セル：YYYY年MM月形式 | ドロップダウンリスト | 過去12ヶ月分の選択肢 |
| 動的売上表示 | VLOOKUP(F2,KPI履歴データ) | 数値・条件付き書式 | 選択月の売上データ表示 |
| 動的利益表示 | VLOOKUP(F2,KPI履歴データ) | 数値・条件付き書式 | 選択月の利益データ表示 |
| 動的ROI表示 | VLOOKUP(F2,KPI履歴データ) | パーセント・条件付き書式 | 選択月のROIデータ表示 |
| 前年同月比売上 | (当月売上-前年同月売上)/前年同月売上×100 | パーセント・矢印アイコン | 前年同月比増減率 |
| 前年同月比利益 | (当月利益-前年同月利益)/前年同月利益×100 | パーセント・矢印アイコン | 前年同月比増減率 |
| 前年同月比ROI | (当月ROI-前年同月ROI)/前年同月ROI×100 | パーセント・矢印アイコン | 前年同月比増減率 |

### 12.6 動的グラフ仕様
| グラフ種別 | データ範囲 | 表示位置 | 更新トリガー |
|-----------|-----------|----------|-------------|
| 売上推移グラフ | 過去12ヶ月売上データ | G5:M15 | F2セル変更時 |
| 利益推移グラフ | 過去12ヶ月利益データ | G17:M27 | F2セル変更時 |
| ROI推移グラフ | 過去12ヶ月ROIデータ | G29:M39 | F2セル変更時 |
| グラフ種類 | 折れ線グラフ + データマーカー | - | 視認性重視 |
| 軸設定 | X軸：月、Y軸：KPI値 | - | 自動スケール |

## 13. 今後の拡張計画

### 13.1 短期（3ヶ月以内）
- モバイル対応（スプレッドシートアプリ）
- 追加KPIの実装
- 予測分析機能

### 13.2 中長期（3ヶ月以降）
- Webアプリケーション化
- 複数マーケットプレイス対応
- AI予測機能の追加

## 14. 更新履歴

### Version 1.1 (2025-08-02)
- マカドCSV処理の改善（Shift-JISエンコーディング対応）
- 返品・キャンセルデータの適切な処理機能追加
- KPI計算機能の大幅強化（リアルタイム更新）
- DateUtilsクラスの機能拡張（日付操作メソッド追加）
- アラート機能の実装
- 重複データ検知・除外機能の追加
- 詳細なデバッグログ機能の実装

### Version 1.2 (2025-08-03)
- KPI計算精度の大幅向上
- ROI計算ロジックの改善（販売データ仕入原価活用）
- 達成率自動計算機能の実装
- データ不整合時の自動補完機能追加
- KPIダッシュボード表示の完全化
- 仕入履歴テーブル構造の定義・整合性修正

### Version 1.3 (2025-08-03)
- 過去月実績表示機能の追加
- KPI履歴シートの新規追加
- 前月比・前年同月比の計算機能
- 過去12ヶ月分のKPI推移管理
- トレンド分析機能の基盤整備

### Version 1.4 (2025-08-05)
- KPI月次管理シートの機能拡張
  - F2セルに期間選択ドロップダウン（過去12ヶ月分）の追加
  - F列に前年同月比表示機能の追加
  - G列以降にグラフエリア追加（売上・利益・ROI推移グラフ）
- 時系列分析機能の実装
  - 選択された月のKPIデータ動的表示
  - 前月比・前年同月比の自動計算・表示
  - グラフの動的更新機能（onEditトリガー連動）
- 動的グラフ機能の追加
  - 売上推移グラフ（過去12ヶ月）
  - 利益推移グラフ（過去12ヶ月）
  - ROI推移グラフ（過去12ヶ月）
  - 期間選択に連動したグラフデータ範囲の自動更新